# 통합 기획서 — 형태1+2 결합 + 무료 스왑풀

> **정의**: 광고 시청 기반 가스비 대납(형태1) + 포인트 적립/결제(형태2) + 자체 LP 기반 무료 스왑풀을 통합한 플랫폼
---

## 1. 제품 개요

### 1.1 서비스 한 줄 요약
사용자가 광고를 시청하면 포인트를 적립하고, 트랜잭션 시 "포인트로 가스 결제" 또는 "광고 보고 즉시 무료" 중 선택 가능. 추가로 자체 LP(유동성 풀)를 운영하여 스왑 시에도 가스비 없이 거래 가능한 통합 플랫폼.

### 1.2 핵심 기능 통합

| 기능 | 형태1 | 형태2 | 통합 버전 |
|------|-------|-------|-----------|
| **광고 시청** | ✅ | ✅ | ✅ (공통) |
| **즉시 무료 트랜잭션** | ✅ | ❌ | ✅ (선택 가능) |
| **포인트 적립** | ❌ | ✅ | ✅ (선택 가능) |
| **포인트로 가스 결제** | ❌ | ✅ | ✅ (선택 가능) |
| **무료 스왑풀** | ❌ | ❌ | ✅ (신규) |

### 1.3 목표 사용자
- **1차**: dApp/앱 개발자 — "광고 보고 무료 전송" + "포인트 적립" + "무료 스왑" 기능을 한 번에 제공
- **2차**: 최종 사용자 — 가스비 없이 전송, 스왑, NFT 민팅 등 모든 온체인 액션 실행
- **3차**: 유동성 제공자 — 스왑풀에 LP 제공하고 수수료 수익
- **4차**: 지갑/앱 개발사 — **"광고 리워드 → 가스 결제"** 기능을 자신의 지갑·앱에 붙이고 싶은 팀  
  → **SDK/API** 또는 **스마트 컨트랙트 연동** 둘 다 지원 (컨트랙트로 연동 시 서드파티 지갑이 우리 포인트·Paymaster 컨트랙트만 호출해 연동 가능)

---

## 2. 통합 사용자 플로우

### 2.1 통합 플로우 (3가지 옵션)

#### 옵션 A: 형태1 방식 (즉시 무료)
1. 사용자가 "무료로 전송하기" 클릭
2. **광고 시청** (전면/리워드)
3. 광고 완료 검증
4. **즉시 트랜잭션 실행** (가스비 Paymaster 대납)
5. 완료

#### 옵션 B: 형태2 방식 (포인트 적립/결제)
1. 사용자가 "광고 보기" 클릭
2. **광고 시청** 완료
3. **포인트 적립** (백엔드 검증 후)
4. 나중에 트랜잭션 시 **"포인트로 결제"** 선택
5. 포인트 차감 + 트랜잭션 실행 (가스비 Paymaster 대납)

#### 옵션 C: 무료 스왑 (신규)
1. 사용자가 "무료 스왑" 클릭
2. **광고 시청** 완료
3. 스왑 풀에서 토큰 교환 (가스비 Paymaster 대납)
4. 스왑 수수료는 LP에서 차감 (또는 광고 수익으로 상쇄)

### 2.2 통합 UI/UX
- **메인 화면**: "즉시 무료 전송" / "포인트 적립" / "무료 스왑" 탭
- **포인트 잔액**: 상단에 표시 (형태2 사용 시)
- **가스 결제 선택**: 트랜잭션 시 "네이티브 가스" / "포인트 결제" / "광고 보고 무료" 선택

---

## 3. 무료 스왑풀 설계

### 3.1 아키텍처

```
┌─────────────────────────────────────────┐
│         사용자 (광고 시청)               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│    AdWallet Swap Pool Contract          │
│  ┌──────────────────────────────────┐  │
│  │  LP Pool (AVAX + 토큰)           │  │
│  │  - 유동성 제공자(LP)가 예치       │  │
│  │  - 스왑 수수료 수익 (LP에게)      │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  Swap Logic (Uniswap V2 스타일)  │  │
│  │  - x * y = k (상수 곱 공식)       │  │
│  │  - 가스비는 Paymaster가 대납      │  │
│  └──────────────────────────────────┘  │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│      Paymaster (가스비 대납)             │
└─────────────────────────────────────────┘
```

### 3.2 스왑풀 컨트랙트 기능

#### 핵심 기능
- **LP 예치/출금**: 유동성 제공자가 AVAX + 토큰 쌍을 예치하고 LP 토큰 받기
- **스왑**: 사용자가 토큰 A → 토큰 B 교환 (가스비 무료)
- **수수료**: 스왑 시 0.3% 수수료 → LP 제공자에게 분배
- **가스비 대납**: 스왑 트랜잭션의 가스비는 Paymaster가 대납

#### 광고 연동
- 스왑 전 **광고 시청 완료 검증** (형태1 방식)
- 또는 **포인트 차감** (형태2 방식)
- 검증 완료 후 스왑 실행

### 3.3 LP 수익 모델
- **LP 제공자**: 스왑 수수료(0.3%) 수익
- **플랫폼**: 광고 수익으로 가스비 상쇄
- **사용자**: 가스비 없이 스왑 가능

---

## 4. 기술 스펙

### 4.1 스마트 컨트랙트

#### 4.1.1 AdWalletSwapPool.sol (신규)
```solidity
contract AdWalletSwapPool {
    // LP 토큰 관리
    mapping(address => uint256) public liquidity;
    
    // 토큰 쌍 (AVAX + ERC20)
    address public tokenA; // AVAX (native)
    address public tokenB; // ERC20 토큰
    
    // 스왑 함수 (가스비 무료)
    function swap(
        address tokenIn,
        address tokenOut,
        uint256 amountIn,
        uint256 minAmountOut,
        bytes calldata adProof // 광고 시청 증명
    ) external;
    
    // LP 예치
    function addLiquidity(
        uint256 amountAVAX,
        uint256 amountToken
    ) external payable returns (uint256 lpTokens);
    
    // LP 출금
    function removeLiquidity(uint256 lpTokens) external;
}
```

#### 4.1.2 기존 컨트랙트 확장
- **AdSponsorPaymaster**: 스왑 트랜잭션도 가스비 대납 지원
- **포인트 컨트랙트** (형태2): 스왑 시 포인트 차감 옵션

#### 4.1.3 지갑/앱 개발사용 컨트랙트 연동 (형태2)

지갑·앱 개발사가 **SDK 없이 스마트 컨트랙트만** 호출해서 "광고 리워드 → 가스 결제"를 붙일 수 있도록, 다음 컨트랙트를 제공한다.

##### 포인트 관리 컨트랙트 (온체인)

```solidity
/// @title 지갑/앱이 포인트 조회·차감 시 사용하는 인터페이스
interface IAdWalletPoints {
    /// @notice 지갑 주소별 포인트 잔액
    function balanceOf(address account) external view returns (uint256);
    
    /// @notice 포인트 적립 (광고 검증 서버 또는 인증된 Relayer만 호출)
    function mint(address to, uint256 amount, bytes calldata proof) external;
    
    /// @notice 포인트 차감 (가스 대납 트랜잭션 시 Paymaster 또는 인증된 모듈이 호출)
    function burn(address from, uint256 amount) external;
    
    /// @notice 포인트로 가스 결제 시: 사용자 대신 차감 후 true 반환 (Paymaster/Executor에서 호출)
    function spendForGas(address user, uint256 pointCost) external returns (bool);
    
    /// @notice 포인트 ↔ 가스비 환산 (1포인트 = N wei 등)
    function pointsToWei(uint256 points) external view returns (uint256);
}
```

##### Paymaster 연동 (포인트 결제 시)

- UserOperation 실행 전, Paymaster가 `IAdWalletPoints.spendForGas(sender, requiredPoints)` 호출로 포인트 차감
- 차감 성공 시에만 가스비 대납 진행
- 지갑/앱은 자신의 UI에서 `balanceOf(user)`로 잔액 표시, 트랜잭션 시 "포인트로 결제" 선택 시 우리 Paymaster + 포인트 컨트랙트를 호출하는 UserOperation 구성만 하면 됨

##### 지갑/앱 연동 시나리오 (컨트랙트만 사용)

| 단계 | 주체 | 동작 |
|------|------|------|
| 1 | 지갑/앱 | `IAdWalletPoints.balanceOf(user)` 호출 → 포인트 잔액 표시 |
| 2 | 사용자 | "포인트로 가스 결제" 선택 후 트랜잭션 서명 |
| 3 | 지갑/앱 | Paymaster 주소 + 포인트 컨트랙트 주소를 쓰는 UserOperation 제출 |
| 4 | Paymaster | `IAdWalletPoints.spendForGas(user, cost)` 호출 → 포인트 차감 후 가스 대납 |

(포인트 적립은 광고 검증 후 백엔드/Relayer가 `mint(to, amount, proof)` 호출로 수행 가능)

##### 배포·연동 정보 제공

- **AdWalletPoints** 컨트랙트 주소 (체인별)
- **AdSponsorPaymaster** 주소 (체인별)
- **EntryPoint** 주소
- 위 인터페이스 ABI 및 연동 가이드 문서

이렇게 하면 서드파티 지갑/앱은 **자체 백엔드 없이** 우리가 배포한 컨트랙트만 호출해 "광고 리워드 → 가스 결제"를 붙일 수 있다.

### 4.2 SDK 확장

#### 4.2.1 새로운 API
```typescript
// 무료 스왑
async swapGasless(
  tokenIn: string,
  tokenOut: string,
  amountIn: string,
  minAmountOut: string,
  paymentMethod: 'ad' | 'points' // 광고 또는 포인트
): Promise<string>

// LP 예치
async addLiquidity(
  amountAVAX: string,
  amountToken: string,
  tokenAddress: string
): Promise<string>

// LP 출금
async removeLiquidity(lpTokens: string): Promise<string>

// 스왑 풀 정보 조회
async getPoolInfo(): Promise<{
  reserveAVAX: string,
  reserveToken: string,
  totalLPTokens: string,
  swapFee: number
}>
```

### 4.3 백엔드/인프라
- **포인트 서버** (형태2): 포인트 적립/차감 API
- **광고 검증 서버**: 광고 시청 완료 검증
- **모니터링**: LP 잔액, 스왑 볼륨, 수수료 수익 추적

---

## 5. 통합 기능 범위

### 5.1 포함 범위 (In Scope)

#### 형태1 기능
- ✅ 광고 시청 후 즉시 무료 트랜잭션
- ✅ Paymaster 가스비 대납
- ✅ 가스 한도·화이트리스트 관리

#### 형태2 기능
- ✅ 포인트 적립 (광고 시청 시)
- ✅ 포인트로 가스 결제
- ✅ 포인트 잔액/내역 조회
- ✅ **지갑/앱 개발사용 컨트랙트 연동** — 포인트·Paymaster를 **스마트 컨트랙트만** 호출해 "광고 리워드 → 가스 결제" 붙이기 (SDK 없이 연동 가능)

#### 스왑풀 기능 (신규)
- ✅ 자체 LP 풀 운영
- ✅ 무료 스왑 (가스비 대납)
- ✅ LP 예치/출금
- ✅ 스왑 수수료 분배

### 5.2 제외 범위 (Out of Scope)
- 포인트 토큰화 (추후 단계)
- 복잡한 AMM 기능 (선택적 유동성, 가격 오라클 등)
- 크로스체인 스왑 (추후 단계)

---

## 6. 사용자 시나리오 (통합)

### 6.1 시나리오 1: 즉시 무료 전송 (형태1)
```
사용자 → "무료로 전송하기" 클릭
      → 광고 시청 (30초)
      → 광고 완료 검증
      → 트랜잭션 실행 (가스비 무료)
      → 완료
```

### 6.2 시나리오 2: 포인트 적립 후 사용 (형태2)
```
사용자 → "광고 보기" 클릭 (여러 번)
      → 포인트 적립 (광고당 100포인트)
      → 잔액: 500포인트
      → "토큰 전송" 클릭
      → "포인트로 결제" 선택
      → 포인트 차감 (200포인트)
      → 트랜잭션 실행 (가스비 무료)
      → 잔액: 300포인트
```

### 6.3 시나리오 3: 무료 스왑 (신규)
```
사용자 → "무료 스왑" 클릭
      → AVAX → USDC 교환 선택
      → 광고 시청 (30초)
      → 광고 완료 검증
      → 스왑 실행 (가스비 무료)
      → 수수료 0.3%는 LP에서 차감
      → 완료
```

### 6.4 시나리오 4: LP 제공자
```
LP 제공자 → "유동성 제공" 클릭
         → AVAX 1개 + USDC 1000개 예치
         → LP 토큰 받음
         → 다른 사용자들이 스왑할 때마다 수수료 수익
         → 언제든지 LP 출금 가능
```

---

## 7. 비즈니스 모델

### 7.1 수익 구조

| 수익원 | 설명 | 수익 주체 |
|--------|------|-----------|
| **광고 수익** | 광고 시청당 CPM/CPA | 플랫폼 |
| **스왑 수수료** | 스왑당 0.3% | LP 제공자 (일부는 플랫폼) |
| **가스비 차액** | 광고 수익 > 가스비 | 플랫폼 |

### 7.2 비용 구조

| 비용 항목 | 설명 | 비용 주체 |
|-----------|------|-----------|
| **가스비 대납** | 모든 트랜잭션 가스비 | 플랫폼 (Paymaster) |
| **인프라** | 서버, RPC, Bundler | 플랫폼 |
| **LP 운영** | 초기 유동성 (선택) | 플랫폼 또는 커뮤니티 |

---

## 8. 개발 로드맵

### Phase 1: 형태1+2 통합 (1-2개월)
- [ ] **포인트 컨트랙트** 구현 (`AdWalletPoints.sol` / `IAdWalletPoints`) — 잔액, 적립, 차감, `spendForGas`
- [ ] Paymaster와 포인트 연동 (포인트 차감 후 가스 대납)
- [ ] 포인트 시스템 백엔드 (광고 검증 → `mint` 호출)
- [ ] UI 통합: "즉시 무료" / "포인트 적립" 선택 가능
- [ ] **지갑/앱 개발사용 연동**: 컨트랙트 주소·ABI·연동 가이드 문서 공개 (컨트랙트만으로 "광고 리워드 → 가스 결제" 붙이기)

### Phase 2: 스왑풀 MVP (2-3개월)
- [ ] AdWalletSwapPool 컨트랙트 개발
- [ ] LP 예치/출금 기능
- [ ] 기본 스왑 기능 (x * y = k)
- [ ] Paymaster와 스왑 연동

### Phase 3: 통합 및 최적화 (3-4개월)
- [ ] 광고 시청 → 스왑 연동
- [ ] 포인트로 스왑 가스 결제
- [ ] LP 대시보드 (수익, 잔액 등)
- [ ] 보안 감사

---

## 9. 기술 스택 (추가)

### 9.1 스왑풀 컨트랙트
- **AMM 모델**: Uniswap V2 스타일 (x * y = k)
- **수수료**: 0.3% (LP 제공자에게 분배)
- **가스 최적화**: 스왑 시 가스비 최소화

### 9.2 프론트엔드
- **스왑 UI**: 토큰 선택, 금액 입력, 미리보기
- **LP 관리 UI**: 예치/출금, 수익 확인
- **통합 대시보드**: 포인트 잔액 + 스왑 + 전송

---

## 10. 성공 지표 (KPI)

### 10.1 제품 지표
- **스왑 성공률** > 99%
- **평균 스왑 시간** < 5초
- **LP 총 가치 (TVL)** 목표 수치
- **일일 스왑 볼륨**

### 10.2 비즈니스 지표
- **광고 수익 대비 가스비 비율** (수익성)
- **LP 제공자 수**
- **포인트 적립 → 사용 전환율**

---

## 11. 리스크 & 대응

| 리스크 | 대응 |
|--------|------|
| **LP 부족으로 스왑 불가** | 초기 유동성 제공, LP 인센티브 프로그램 |
| **가격 조작 (스왑풀)** | 최소 유동성 요구, 가격 오라클 연동 (추후) |
| **가스비 급등** | 동적 한도, 광고 단가 조정 |
| **포인트 남발** | 일일 적립/사용 한도 |

---

## 12. 다음 단계

1. **스왑풀 컨트랙트 설계** 상세화
2. **LP 토큰 표준** 결정 (ERC-20 기반)
3. **초기 유동성 전략** 수립
4. **보안 감사** 계획

이 문서는 **형태1+2 통합 + 무료 스왑풀**의 기획을 정의한다.
