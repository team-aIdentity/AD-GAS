# 통합 개발 기획서 — 형태1+2 결합 + 무료 스왑풀

> **기술 정의**: 광고 시청 기반 가스비 대납(형태1) + 포인트 적립/결제(형태2) + 자체 LP 스왑풀을 하나의 플랫폼으로 구현. 지갑/앱 개발사는 SDK 또는 **스마트 컨트랙트만**으로 "광고 리워드 → 가스 결제" 연동 가능.

**관련 문서**: [통합_기획서.md](./통합_기획서.md) · [BUSINESS_MODEL.md](./BUSINESS_MODEL.md)

---

## 1. 아키텍처 개요

### 1.1 현재 구현 기준

| 구분 | 현재 구현 | 통합 시 확장 |
|------|-----------|--------------|
| **형태1 (즉시 무료)** | `AdSponsorPaymaster.sol`, `AdWalletSponsoredTransfer.sol`, `GaslessSDK` + `Form1TransferUI` | 유지·재사용 |
| **형태2 (포인트)** | 없음 | `AdWalletPoints.sol` + 백엔드/Relayer |
| **스왑풀** | 없음 | `AdWalletSwapPool.sol` |
| **지갑/앱 연동** | SDK (Biconomy MEE) | **컨트랙트 인터페이스** (`IAdWalletPoints`) 공개로 SDK 없이 연동 |

### 1.2 시스템 구성도

```
[사용자 / dApp / 지갑앱]
         │
         ├── 옵션 A: 형태1 ──→ [광고 시청] → [GaslessSDK] → [Bundler/EntryPoint] → [Paymaster] → 가스 대납
         │
         ├── 옵션 B: 형태2 ──→ [광고 시청] → [포인트 적립: AdWalletPoints.mint]
         │                    [트랜잭션 시] → [포인트 차감: spendForGas] → [Paymaster] → 가스 대납
         │
         ├── 옵션 C: 스왑 ──→ [광고 시청] → [AdWalletSwapPool.swap] (가스 Paymaster 대납)
         │
         └── 지갑/앱 개발사 ──→ [IAdWalletPoints.balanceOf / spendForGas] + [Paymaster] (컨트랙트만 호출)
```

### 1.3 기술 스택 (통합)

| 구분 | 기술 |
|------|------|
| 스마트 컨트랙트 | Solidity ^0.8.20, OpenZeppelin, Hardhat (기존) + AdWalletPoints, AdWalletSwapPool |
| 형태1 | EIP-4337 Paymaster (`AdSponsorPaymaster`), 메타트랜잭션 (`AdWalletSponsoredTransfer`) |
| SDK | TypeScript, Viem, Biconomy AbstractJS (기존 `GaslessSDK`) |
| 프론트엔드 | Next.js, wagmi, 기존 `Form1TransferUI` · `AdminDepositPage` 확장 |
| 인프라 | RPC, Bundler(또는 MEE), 광고 검증 서버, 포인트 백엔드(선택) |

---

## 2. 스마트 컨트랙트 스펙

### 2.1 기존 컨트랙트 (참조)

#### AdSponsorPaymaster (`contracts/contracts/AdSponsorPaymaster.sol`)
- **역할**: EIP-4337 Paymaster, 호출당/일일 가스 한도, 화이트리스트, 비상 정지
- **연동**: EntryPoint에 예치, `validatePaymasterUserOp` / `postOp`
- **통합 시**: 스왑·포인트 결제 트랜잭션도 동일 Paymaster로 대납 가능하도록 정책만 확장

#### AdWalletSponsoredTransfer (`contracts/contracts/AdWalletSponsoredTransfer.sol`)
- **역할**: 사용자 서명(EIP-712) 검증 후 네이티브/ERC20 전송, 가스비는 스폰서 부담
- **관리자**: `admin`, `depositNative` / `withdrawNative`, `getNativeDepositPool`
- **통합 시**: 형태1 “즉시 무료 전송” 계속 사용, 프론트는 `Form1TransferUI` 등 기존 유지

### 2.2 신규: AdWalletPoints (형태2 + 지갑/앱 연동)

#### 인터페이스 (지갑/앱이 컨트랙트만으로 연동할 때 사용)

```solidity
// docs/통합_기획서.md 4.1.3과 동일
interface IAdWalletPoints {
    function balanceOf(address account) external view returns (uint256);
    function mint(address to, uint256 amount, bytes calldata proof) external;
    function burn(address from, uint256 amount) external;
    function spendForGas(address user, uint256 pointCost) external returns (bool);
    function pointsToWei(uint256 points) external view returns (uint256);
}
```

#### 구현 요구사항
- **저장**: `mapping(address => uint256) public balanceOf;`
- **mint**: `onlyRole(MINTER)` 또는 인증된 Relayer, `proof`로 광고 시청 검증 (오프체인 검증 후 서명 등)
- **burn / spendForGas**: Paymaster 또는 인증된 Executor만 호출, 가스 대납 전 포인트 차감
- **pointsToWei**: 관리자 설정 또는 고정 환율 (예: 1 point = 1e12 wei)
- **이벤트**: `Transfer`(적립/차감), `SpendForGas(user, amount)`

#### 배포·연동
- 체인별 배포 후 **컨트랙트 주소 + ABI** 공개
- 지갑/앱은 `balanceOf(user)`로 잔액 표시, UserOperation 시 Paymaster가 `spendForGas` 호출

### 2.3 신규: AdWalletSwapPool (무료 스왑)

#### 핵심 함수
- `addLiquidity(uint256 amountAVAX, uint256 amountToken) external payable returns (uint256 lpTokens)`
- `removeLiquidity(uint256 lpTokens) external`
- `swap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut, bytes calldata adProof) external`
- `getReserves() external view returns (uint256 reserve0, uint256 reserve1)`

#### 규칙
- AMM: Uniswap V2 스타일 `x * y = k`, 수수료 0.3% → LP에 반영 또는 분배
- 스왑 시 가스비는 Paymaster 대납 (같은 체인 AdSponsorPaymaster 또는 전용 Paymaster)
- `adProof`: 광고 시청 완료 증명 (형태1) 또는 포인트 차감은 Paymaster/외부에서 처리 후 호출

#### 보안
- ReentrancyGuard, 일일 스왑 한도(선택), 최소 유동성 검사

### 2.4 Paymaster 확장 (통합)

- **형태1**: 기존대로 UserOperation 가스 대납
- **형태2**: `validatePaymasterUserOp` 내부에서 (또는 별도 Executor에서) `IAdWalletPoints(spendForGas).spendForGas(sender, cost)` 호출 후 진행
- **스왑**: 스왑 풀 호출 트랜잭션에 대해 동일 Paymaster로 가스 대납

---

## 3. SDK 확장 (현재 코드 기준)

### 3.1 기존 GaslessSDK (`src/core/GaslessSDK.ts`)

- **이미 구현**: `setAdTrigger`, `getAdTrigger`, `sendGaslessTransaction` (beforeTransaction → 광고 시청 후 트랜잭션)
- **설정**: `SdkConfig` — `publicClient`, `walletClient`, `apiKey`(Biconomy)
- **통합 시**: 형태1은 그대로 사용. 형태2용으로 `getPointsBalance(address?)`, `sendTransactionWithPoints(tx)` 등 추가 시 새 메서드로 확장

### 3.2 통합 시 추가 API (목표)

| API | 설명 |
|-----|------|
| `getPointsBalance(account?)` | `IAdWalletPoints.balanceOf(account ?? wallet)` 조회 |
| `sendTransactionWithPoints(tx)` | 포인트 차감 + UserOperation 제출 (Paymaster가 spendForGas 호출) |
| `swapGasless(tokenIn, tokenOut, amountIn, minOut, paymentMethod)` | 스왑 풀 호출, paymentMethod: 'ad' \| 'points' |
| `addLiquidity(amountAVAX, amountToken, tokenAddress)` | LP 예치 |
| `removeLiquidity(lpTokens)` | LP 출금 |
| `getPoolInfo(poolAddress?)` | 스왑 풀 reserve, 수수료 등 조회 |

### 3.3 광고 트리거 (기존 유지)

- `AdTrigger.beforeTransaction`: 형태1·스왑(광고 결제) 시 사용
- 형태2 포인트 적립은 앱에서 “광고 보기” 버튼 → 광고 시청 → 백엔드/Relayer가 `mint` 호출

---

## 4. 프론트엔드 (현재 코드 기준)

### 4.1 기존 구현

- **Form1TransferUI** (`frontend/src/components/Form1TransferUI.tsx`): 형태1 “광고 보고 무료 전송”, AdTrigger 연동
- **AdminDepositPage** (`frontend/src/components/admin/AdminDepositPage.tsx`): 관리자 예치/출금, `AdWalletSponsoredTransfer` 연동
- **wagmi**: `wagmi.config.ts`, `useAccount`, `useConnect` 등

### 4.2 통합 시 UI 확장

- **탭 또는 메뉴**: “즉시 무료 전송”(형태1) / “포인트 적립” / “포인트로 결제” / “무료 스왑”
- **포인트 잔액**: 상단 또는 사이드바에 `IAdWalletPoints.balanceOf(address)` 표시
- **스왑 UI**: 토큰 선택, 금액 입력, “광고 보고 스왑” 또는 “포인트로 스왑”
- **LP UI**: 예치/출금, 보유 LP·수익 표시 (Phase 2)

### 4.3 환경 변수 (추가 예시)

```env
# 기존
NEXT_PUBLIC_ADWALLET_CONTRACT_ADDR_AVALANCHE=
NEXT_PUBLIC_BICONOMY_API_KEY=

# 통합 추가
NEXT_PUBLIC_ADWALLET_POINTS_ADDRESS=
NEXT_PUBLIC_ADWALLET_SWAP_POOL_ADDRESS=
```

---

## 5. 백엔드/인프라

### 5.1 광고 검증

- 형태1: 기존처럼 클라이언트 또는 백엔드에서 “광고 시청 완료” 검증 후 진행
- 형태2: 광고 시청 완료 시 **포인트 적립** — 백엔드가 검증 후 Relayer로 `AdWalletPoints.mint(user, amount, proof)` 호출

### 5.2 포인트 적립 플로우

1. 클라이언트: 광고 SDK 콜백(시청 완료) → 백엔드에 (userAddress, adId, timestamp 등) 전송
2. 백엔드: 검증 후 일회성 토큰/서명 발급 또는 Relayer에 mint 요청
3. Relayer: `AdWalletPoints.mint(to, amount, proof)` 트랜잭션 제출 (가스비는 플랫폼 부담)

### 5.3 지갑/앱 개발사 (컨트랙트만 연동)

- **필요 정보**: AdWalletPoints 주소, AdSponsorPaymaster 주소, EntryPoint 주소, ABI
- **자체 백엔드 불필요**: 잔액은 `balanceOf`, 결제는 UserOperation + Paymaster가 `spendForGas` 호출
- **문서**: “지갑/앱 연동 가이드”에서 위 컨트랙트 호출 순서·ABI·예제 코드 제공

---

## 6. 배포·환경

### 6.1 체인 (기존 + 동일)

- **1차**: Avalanche, Base, BNB 등 (현재 `AdWalletSponsoredTransfer` 배포 체인)
- **2차**: Sepolia 등 테스트넷 (검증용)

### 6.2 배포 순서 (권장)

1. **AdSponsorPaymaster** (기존) — 유지
2. **AdWalletSponsoredTransfer** (기존) — 유지
3. **AdWalletPoints** — 신규 배포, MINTER/Relayer 역할 설정
4. **AdWalletSwapPool** — 신규 배포, 토큰 쌍·수수료 설정
5. Paymaster 정책 업데이트 (스왑·포인트 트랜잭션 허용)

### 6.3 스크립트 (기존 참조)

- `contracts/scripts/deploy.ts`: AdSponsorPaymaster
- `contracts/scripts/deploy-sponsored-transfer.ts`: AdWalletSponsoredTransfer
- 추가: `deploy-points.ts`, `deploy-swap-pool.ts`

---

## 7. 테스트

### 7.1 단위 테스트

- **AdWalletPoints**: mint/burn/spendForGas, 권한, 잔액 일관성
- **AdWalletSwapPool**: addLiquidity/removeLiquidity, swap (x*y=k), 수수료
- **Paymaster**: 기존 + 포인트 차감 연동 시 검증

### 7.2 통합 테스트

- 형태1: 기존 E2E (광고 시청 → 무료 전송)
- 형태2: 광고 시청 → mint → 포인트로 트랜잭션 → spendForGas 후 성공
- 스왑: 유동성 추가 → 광고(또는 포인트) → 스왑 → 가스 대납 확인
- 지갑 연동: 외부 컨트랙트만으로 balanceOf + UserOperation(spendForGas) 시뮬레이션

### 7.3 보안

- 재진입, 한도 초과, 권한 없는 mint/burn/spendForGas
- 스왑 풀: 슬리피지·최소 출력, 유동성 고갈 시 revert

---

## 8. 통합 개발 체크리스트

### Phase 1: 형태1+2 + 지갑/앱 컨트랙트 연동

- [ ] **AdWalletPoints.sol** 구현 (IAdWalletPoints, mint/burn/spendForGas, pointsToWei)
- [ ] Paymaster(또는 Executor)에서 포인트 연동 (spendForGas 후 가스 대납)
- [ ] 포인트 적립 백엔드/Relayer (광고 검증 → mint)
- [ ] SDK: getPointsBalance, sendTransactionWithPoints (선택)
- [ ] 프론트: 포인트 잔액 표시, “포인트로 결제” 옵션
- [ ] **지갑/앱 연동 문서**: 컨트랙트 주소·ABI·연동 시나리오·예제
- [x] 형태1 기존 (AdSponsorPaymaster, AdWalletSponsoredTransfer, Form1TransferUI) 유지

### Phase 2: 스왑풀 MVP

- [ ] AdWalletSwapPool.sol (addLiquidity, removeLiquidity, swap, getReserves)
- [ ] Paymaster와 스왑 트랜잭션 가스 대납 연동
- [ ] SDK: swapGasless, addLiquidity, removeLiquidity, getPoolInfo
- [ ] 프론트: 스왑 UI, LP 예치/출금 UI

### Phase 3: 통합·최적화

- [ ] 광고 시청 → 스왑 플로우 (adProof)
- [ ] 포인트로 스왑 가스 결제
- [ ] LP 대시보드 (수익·잔액)
- [ ] 보안 감사 (Paymaster, Points, SwapPool)

---

## 9. 문서·코드 인덱스 (현재 기준)

| 구분 | 경로 |
|------|------|
| 형태1 Paymaster | `contracts/contracts/AdSponsorPaymaster.sol` |
| 형태1 스폰서 전송 | `contracts/contracts/AdWalletSponsoredTransfer.sol` |
| Gasless SDK | `src/core/GaslessSDK.ts` |
| 형태1 UI | `frontend/src/components/Form1TransferUI.tsx` |
| 관리자 페이지 | `frontend/src/components/admin/AdminDepositPage.tsx` |
| 배포 스크립트 | `contracts/scripts/deploy*.ts` |
| 기획 | `docs/통합_기획서.md` |
| 사업 모델 | `docs/BUSINESS_MODEL.md` |

이 문서는 **통합 플랫폼**의 개발 스펙을 정의하며, 제품 범위·KPI는 **통합_기획서.md**, 사업화 방향은 **BUSINESS_MODEL.md**를 참고한다.
